namespace = destape

### Designating the Tapado (sent to Benemérito)
long_character_event = {
	id = destape.1
	desc = EVTDESC_destape_1
	picture = GFX_evt_powerful_ruler
	#border = GFX_event_normal_frame_war

	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_destape_1
	}
}

### Tapado revoked (sent to Benemérito)
character_event = {
	id = destape.2
	desc = EVTDESC_destape_2
	picture = GFX_evt_suspicious_noble
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_destape_2
	}
}

### Lose Tapado trait by being exiled from realm, dying
character_event = {
	id = destape.3
	desc = DEBUG
	is_triggered_only = yes # Triggered by on_death, on_yearly_pulse
	hide_window = yes
	
	trigger = {
		OR = {
			trait = tapado
			trait = destapado
		}
	}
	
	immediate = {
		remove_trait = tapado
		remove_trait = destapado
	}
	
	option = {
		name = DEBUG
	}
}

### Destape Ceremony Decision
narrative_event = {
	id = destape.4
	title = "TITLE_DESTAPE"
	desc = EVTDESC_destape_4
	picture = GFX_evt_powerful_ruler
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_destape_4 # ready the ceremony
		set_character_flag = holding_destape
		hidden_tooltip = {

			# Call invitation event
			any_realm_character = {
				limit = {
					is_adult = yes
					NOT = { trait = incapable }
					# NOT = { has_character_flag = do_not_disturb }
					prisoner = no	
				}
				narrative_event = { id = destape.5 days = 10 }
			}
			character_event = { id = destape.12 days = 150 } # Safety catch flag clearing
		}
	}
	option = {
		name = EVTOPTB_destape_4 # I'm not ready
		hidden_tooltip = {
			letter_event = {
				id = destape.12
			}
		}
	}
}

### Voters invited
narrative_event = {
	id = destape.5
	title = "TITLE_DESTAPE"
	desc = EVTDESC_destape_5
	picture = GFX_evt_courier

	is_triggered_only = yes

	# Display invitation event to every vassal limited to the realm
	trigger = {
		AND = {
			NOT = { has_character_flag = attending_destape }
			NOT = { has_character_flag = holding_destape }
			OR = {
				is_landed = yes
				has_landed_title = d_sagrado_corazon
				has_landed_title = d_cristo_rey
			}
		}
	}

	option = {
		name = EVTOPTA_destape_5 # of course
		set_character_flag = attending_destape
		set_character_flag = do_not_disturb
		# hidden_tooltip = {
		# 	narrative_event = { id = destape.6 days = 15 } # ceremony start
		# }
		hidden_tooltip = {
			character_event = { id = destape.12 days = 150 } # Safety catch flag clearing
		} 
	}
}

### Destape Begins
narrative_event = {
	id = destape.6
	title = "TITLE_DESTAPE_BEGINS"
	desc = EVTDESC_destape_6
	picture = GFX_evt_shadowy_cabal

	# is_triggered_only = yes
	
	#war = no

	# pretrigger = {
	# 	only_playable
	# }

	trigger = {
			NOR = { 
				has_character_flag = destape_begins 
				has_character_flag = destape_has_ended
			}
			OR = {
				has_character_flag = attending_destape
				has_character_flag = holding_destape
			}
	}
			
	option = {
		name = EVTOPTA_destape_6 # time for the dedazo
		hidden_tooltip = {
			set_character_flag = destape_begins
			any_realm_character = {
				limit = {
					trait = tapado
				}
				narrative_event = { id = destape.7 }
			}
		}
	}
}

### Tapado is unveiled - sent to Tapado
narrative_event = {
	id = destape.7
	title = "TITLE_DESTAPADO"
	desc = EVTDESC_destape_7
	picture = GFX_evt_society_joining

	is_triggered_only = yes
	
	trigger = {
		AND = {
			trait = tapado
			NOT = { trait = destapado }
			has_character_flag = destape_begins
		}
	}
	
	option = {
		name = EVTOPTA_destape_7
		hidden_tooltip = {	
			remove_trait = tapado
			add_trait = destapado
			clr_character_flag = destape_begins
			set_character_flag = destape_has_ended
			
			top_liege = {
				narrative_event = { id = destape.9 }
			}
		}
	}
}

### Tapado is unveiled - sent to vassals for decision
narrative_event = {
	id = destape.8
	title = "TITLE_DESTAPADO"
	desc = EVTDESC_destape_8
	picture = GFX_evt_society_joining
	portrait = FROMFROM

	capable_only = yes
	prisoner = no
	#war = no

	is_triggered_only = yes

	trigger = {
		NOR = { 
			trait = destapado 
			trait = tapado
			has_character_flag = destape_has_ended
		}
		has_character_flag = destape_begins
		has_character_flag = attending_destape
	}
	
	option = {
		name = EVTOPTA_destape_8 # fall in line
		trigger = {
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.2
				ai = yes
				is_rival = FROM
			}
		}

		hidden_tooltip = {
			clr_character_flag = destape_begins
			add_character_modifier = {
				name = approves_destapado
				duration = 1826
			}
			set_character_flag = destape_has_ended
			character_event = {
				id = destape.10
			}
		}
	}

	option = {
		name = EVTOPTB_destape_8 # Oppose the destapado
		trigger = {
		}
		ai_chance = {
			factor = 0.1
			modifier = {
				factor = 100
				ai = yes
				is_rival = FROM
			}
		}

		hidden_tooltip = {
			clr_character_flag = destape_begins
			add_character_modifier = {
				name = opposes_destapado
				duration = 1826
			}
			set_character_flag = destape_has_ended
			narrative_event = {
				id = destape.10
			}
		}
	}
}

### Destape outcome - Let emperor know the ceremony is over
narrative_event = {
	id = destape.9
	title = "TITLE_DESTAPADO"
	desc = EVTDESC_destape_9
	picture = GFX_evt_feast
	portrait = FROM

	is_triggered_only = yes
	
	trigger = {
		AND = {
			has_character_flag = holding_destape
			has_character_flag = destape_begins
			# has_character_flag = destape_has_ended
		}
	}

	option = {
		name = EVTOPTA_destape_9
		hidden_tooltip = {
			clr_character_flag = holding_destape
			clr_character_flag = destape_begins
			clr_character_flag = do_not_disturb
			# clr_character_flag = destape_has_ended
			any_realm_character = {
				limit = {
					has_character_flag = attending_destape
					has_character_flag = destape_begins
					NOT = { trait = tapado }
					NOT = { trait = destapado }
					NOT = { has_character_flag = destape_has_ended }
					NOT = { has_character_flag = hosting_destape }						
				}
				narrative_event = { id = destape.8 }
			}
		}
	}
}

### Destape outcome - Let attendees know the ceremony is over
narrative_event = {
	id = destape.10
	title = "TITLE_DESTAPE"
	desc = EVTDESC_destape_10
	picture = GFX_evt_feast

	# is_triggered_only = yes
	
	# pretrigger = {
	# 	only_playable
	# }

	trigger = {
		AND = {
			has_character_flag = attending_destape
			has_character_flag = destape_has_ended
		}
	}

	option = {
		name = EVTOPTA_destape_10
		hidden_tooltip = {
			clr_character_flag = attending_destape
			clr_character_flag = destape_begins
			clr_character_flag = destape_has_ended
			clr_character_flag = do_not_disturb
		}
	}
}

### Destape has been canceled
letter_event = {
	id = destape.11
	title = "TITLE_DESTAPE"
	desc = EVTDESC_destape_11
	picture = GFX_evt_joust

	is_triggered_only = yes

	option = {
		name = "EVTOPTA_destape_11"
		clr_character_flag = attending_destape
		clr_character_flag = hosting_destape
		clr_character_flag = destape_begins
		clr_character_flag = do_not_disturb
	}
}

###########################################
# Flag management						#
###########################################

# Safety catch - clears character flags and modifiers
character_event = {
	id = destape.12
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		clr_character_flag = do_not_disturb
		clr_character_flag = attending_destape
		clr_character_flag = destape_has_ended
		clr_character_flag = holding_destape
		clr_character_flag = destape_begins
		any_realm_character = {
			limit = {
				has_character_flag = attending_destape
			}
			clr_character_flag = attending_destape
		}
		any_realm_character = {
			limit = {
				has_character_flag = destape_has_ended
			}
			clr_character_flag = destape_has_ended
		}		
	}
}

### Lose Tapado trait by becoming emperor
character_event = {
	id = destape.13
	desc = DEBUG
	is_triggered_only = yes # Triggered by on_death, on_yearly_pulse
	hide_window = yes
	
	trigger = {
		has_landed_title = e_mexico
		OR = {
			trait = tapado
			trait = destapado
		}
	}
	
	immediate = {
		remove_trait = tapado
		remove_trait = destapado
	}
	
	option = {
		name = DEBUG
	}
}

# #Clear variables on first start for the Emperor.
# character_event = {
# 	id = destape.20
# 	hide_window = yes 
# 	is_triggered_only = yes
	

# 	trigger = {
# 		is_save_game = no
# 		has_law = succ_mex_elective 
# 	}

# 	immediate = {
# 		set_variable = { which = byzantine_credibility_discharged_hero value = 0 }
# 		set_variable = { which = byzantine_credibility_appointed_sycophant value = 0 }
# 	}
# }