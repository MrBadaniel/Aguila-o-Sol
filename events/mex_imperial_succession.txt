namespace = destape

### Designating the Tapado (sent to Benemérito)
character_event = {
	id = destape.1
	desc = EVTDESC_destape_1
	picture = GFX_evt_powerful_ruler
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_destape_1
	}
}

### Tapado revoked (sent to Benemérito)
character_event = {
	id = destape.2
	desc = EVTDESC_destape_2
	picture = GFX_evt_suspicious_noble
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_destape_2
	}
}

### Lose Tapado trait by being exiled from realm
character_event = {
	id = destape.3
	desc = DEBUG
	is_triggered_only = yes # Triggered by on_death, on_yearly_pulse
	hide_window = yes
	
	trigger = {
		OR = {
			trait = tapado
			trait = destapado
			trait = se_movio
		}
	}
	
	immediate = {
		remove_trait = tapado
		remove_trait = destapado
		remove_trait = se_movio
	}
	
	option = {
		name = DEBUG
	}
}

### Destape Ceremony Decision
character_event = {
	id = destape.4
	title = "TITLE_DESTAPE"
	desc = EVTDESC_destape_4
	picture = GFX_evt_feast
	
	is_triggered_only = yes

	option = {
		name = "EVTOPTA_destape_4"  # ready the ceremony
		hidden_tooltip = {
			character_event = { id = destape.6 days = 60 } # Tournament start
			any_realm_character = {
				limit = {
					OR = { 
						has_job_title = job_chancellor
						has_job_title = job_marshal
						has_job_title = job_treasurer
						has_job_title = job_spymaster
						has_job_title = job_spiritual
						has_minor_title = title_councilmember_king #Generic advisors
						has_minor_title = title_councilmember_emperor
						has_minor_title = title_regent
						has_minor_title = title_commander
					}
					age = 16
					NOT = { trait = incapable }
					prisoner = no	
				}
				clr_character_flag = destape_has_ended
				character_event = { id = destape.5 }
			}
		}
	}
	option = {
		name = "EVTOPTB_destape_4"  # I'm not ready
		hidden_tooltip = {
			character_event = {
				id = destape.7
				days = 15
				random = 2
			}
		}
	}
}

### Voters invited
character_event = {
	id = destape.5
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_5"
	picture = "GFX_evt_courier"

	is_triggered_only = yes

	trigger = { NOT = { is_inaccessible_trigger = yes } }

	option = {
		name = "EVTOPTA_destape_5"  # of course
		ai_chance = {
			factor = 100
			modifier  = {
				factor = 0.001
				ai = yes
				is_inaccessible_trigger = yes
			}
		}
		set_character_flag = attending_destape
		set_character_flag = do_not_disturb
		hidden_tooltip = { character_event = { id = destape.11 days = 300 } } # Safety catch flag clearing
	}
	option = {
		name = "EVTOPTB_destape_5"  # what's the point
		ai_chance = {
			factor = 0.1
		}
	}
}

### Destape Begins
letter_event = {
	id = destape.6
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_6"
	picture = "GFX_evt_feast"

	is_triggered_only = yes
	
	war = no

	option = {
		name = "EVTOPTA_destape_6"  # time for the dedazo
		
		trigger = {
		}
		
		hidden_tooltip = {
			set_character_flag = destape_begins
			set_character_flag = attending_destape
			any_realm_character = {
				limit = {
					trait = tapado
				}
				character_event = { id = destape.8 }
			}
		}
	}
	option = {
		name = "EVTOPTB_destape_6"
		trigger = {
			war = yes
		}
		scaled_wealth = 0.5
		hidden_tooltip = {
			any_realm_character = {
				limit = {
					has_character_flag = attending_destape
				}
				character_event = { id = destape.7 }
			}
		}
		clr_character_flag = do_not_disturb
		clr_character_flag = attending_tournament
	}
}

### Destape has been cancelled
character_event = {
	id = destape.7
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_7"
	picture = "GFX_evt_joust"

	is_triggered_only = yes

	option = {
		name = "EVTOPTA_destape_7"
		clr_character_flag = attending_tournament
		clr_character_flag = do_not_disturb
	}
}

### Tapado is unveiled
character_event = {
	id = destape.8
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_8"
	picture = "GFX_evt_joust"

	is_triggered_only = yes

	option = {
		name = "EVTOPTA_destape_8"
		add_trait = destapado
		character_event = { id = destape.9 }
	}
}

### Voter decisions
character_event = {
	id = destape.9
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_9"
	picture = GFX_evt_feast

	capable_only = yes
	prisoner = no
	war = no

	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA_destape_9"  # fall in line
		trigger = {
		}
		ai_chance = {
			factor = 100
			modifier  = {
				factor = 0.2
				ai = yes
				is_rival = ROOT
			}
		}

		hidden_tooltip = {
			any_realm_character = {
				limit = {
					has_character_flag = attending_destape
				}
				set_character_flag = approves_destapado
			}
		}
	}

	option = {
		name = "EVTOPTB_destape_9"  # Oppose the destapado
		trigger = {
		}
		ai_chance = {
			factor = 0.1
		}

		hidden_tooltip = {
			any_realm_character = {
				limit = {
					has_character_flag = attending_destape
				}
				set_character_flag = opposes_destapado
			}
		}
	}
}

### Destape outcome
character_event = {
	id = destape.10
	title = "TITLE_DESTAPE"
	desc = "EVTDESC_destape_10"
	picture = GFX_evt_feast

	is_triggered_only = yes

	option = {
		name = "EVTOPTA_destape_10"
		set_character_flag = approves_destapado
	}
}

###########################################
# Flag management                         #
###########################################

# Safety catch - clears character flags and modifiers
character_event = {
	id = destape.11

	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		clr_character_flag = do_not_disturb
		clr_character_flag = attending_destape
		clr_character_flag = destape_has_ended
		any_realm_character = {
			limit = {
				has_character_flag = attending_destape
			}
			clr_character_flag = attending_destape
			clr_character_flag = approves_destapado
			clr_character_flag = opposes_destapado
		}		
	}
}